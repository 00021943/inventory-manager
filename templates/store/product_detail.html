{% extends 'base.html' %}
{% load cart_filters %}

{% block title %}{{ product.name }} - Retail Store{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="row g-0">
        <div class="col-md-6">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="img-fluid rounded-start w-100" alt="{{ product.name }}"
                style="max-height: 500px; object-fit: cover;">
            {% else %}
            <div class="bg-secondary text-white d-flex align-items-center justify-content-center h-100"
                style="min-height: 400px;">
                <i class="bi bi-image fs-1"></i>
            </div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <div class="card-body p-5">
                <small class="text-muted">{{ product.category.name }}</small>
                <h1 class="card-title mb-3">{{ product.name }}</h1>
                <h2 class="text-primary mb-4">${{ product.price }}</h2>

                <p class="card-text">{{ product.description }}</p>

                <div class="mb-4">
                    {% if product.stock_quantity > 0 %}
                    <span class="badge bg-success fs-6">In Stock ({{ product.stock_quantity }} available)</span>
                    {% else %}
                    <span class="badge bg-danger fs-6">Out of Stock</span>
                    {% endif %}
                </div>

                <div class="d-grid gap-2 col-md-8">
                    {% if user.is_authenticated %}
                        {% if product.stock_quantity > 0 %}
                            {% with product_id=product.pk|stringformat:"s" %}
                                {% if product_id in cart %}
                                <div class="btn-group btn-group-lg" role="group" data-cart-controls="{{ product.pk }}">
                                    <a href="{% url 'update_cart_quantity' product.pk 'decrease' %}" 
                                       class="btn btn-outline-primary"
                                       data-cart-action="decrease"
                                       data-product-id="{{ product.pk }}">
                                        <i class="bi bi-dash"></i>
                                    </a>
                                    <button class="btn btn-primary" disabled style="min-width: 80px;" data-product-quantity="{{ product.pk }}">
                                        {{ cart|get_item:product_id }}
                                    </button>
                                    <a href="{% url 'update_cart_quantity' product.pk 'increase' %}" 
                                       class="btn btn-outline-primary"
                                       data-cart-action="increase"
                                       data-product-id="{{ product.pk }}">
                                        <i class="bi bi-plus"></i>
                                    </a>
                                </div>
                                <a href="{% url 'add_to_cart' product.pk %}" class="btn btn-primary btn-lg" style="display: none;" data-add-button="{{ product.pk }}">Add to Cart</a>
                                {% else %}
                                <div class="btn-group btn-group-lg" role="group" data-cart-controls="{{ product.pk }}" style="display: none;">
                                    <a href="{% url 'update_cart_quantity' product.pk 'decrease' %}" 
                                       class="btn btn-outline-primary"
                                       data-cart-action="decrease"
                                       data-product-id="{{ product.pk }}">
                                        <i class="bi bi-dash"></i>
                                    </a>
                                    <button class="btn btn-primary" disabled style="min-width: 80px;" data-product-quantity="{{ product.pk }}">0</button>
                                    <a href="{% url 'update_cart_quantity' product.pk 'increase' %}" 
                                       class="btn btn-outline-primary"
                                       data-cart-action="increase"
                                       data-product-id="{{ product.pk }}">
                                        <i class="bi bi-plus"></i>
                                    </a>
                                </div>
                                <a href="{% url 'add_to_cart' product.pk %}" class="btn btn-primary btn-lg" data-add-button="{{ product.pk }}">Add to Cart</a>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                        <button class="btn btn-secondary btn-lg" disabled>Out of Stock</button>
                        {% endif %}
                    {% else %}
                        {% if product.stock_quantity > 0 %}
                        <a href="{% url 'login' %}" class="btn btn-primary btn-lg">Login to Add to Cart</a>
                        {% else %}
                        <button class="btn btn-secondary btn-lg" disabled>Out of Stock</button>
                        {% endif %}
                    {% endif %}
                    <a href="{% url 'product_catalog' %}" class="btn btn-outline-secondary">Back to Catalog</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}